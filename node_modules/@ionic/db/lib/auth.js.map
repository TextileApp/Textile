{"version":3,"sources":["../src/auth.js"],"names":["authEndpoint","clearAuthTokens","HORIZON_JWT","name","endpointForName","methods","hasOwnProperty","_root","Error","_authMethods","ajax","_horizonPath","map","response","do","authMethods","of","FakeStorage","_storage","Map","setItem","a","b","set","getItem","get","removeItem","delete","getStorage","storeLocally","storage","window","localStorage","undefined","error","sessionStorage","TokenStorage","authType","path","_path","_authType","token","_getHash","val","JSON","parse","_setHash","hash","stringify","jwt","current","remove","setAuthFromQueryParams","parsed","location","search","horizon_token","handshake","method","hasAuthToken","meta","atob","split","exp","now","Date","getTime","e"],"mappings":"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","file":"auth.js","sourcesContent":["import queryParse from './util/query-parse'\nimport { Observable } from 'rxjs/Observable'\nimport 'rxjs/add/operator/do'\nimport 'rxjs/add/operator/map'\nimport 'rxjs/add/observable/dom/ajax'\n\nconst HORIZON_JWT = 'ionicdb-jwt'\n\n/** @this Horizon **/\nexport function authEndpoint(name) {\n  const endpointForName = methods => {\n    if (methods.hasOwnProperty(name)) {\n      return this._root + methods[name]\n    } else {\n      throw new Error(`Unconfigured auth type: ${name}`)\n    }\n  }\n  if (!this._authMethods) {\n    return Observable.ajax(`${this._horizonPath}/auth_methods`)\n      .map(ajax => ajax.response)\n      .do(authMethods => {\n        this._authMethods = authMethods\n      }).map(endpointForName)\n  } else {\n    return Observable.of(this._authMethods).map(endpointForName)\n  }\n}\n\n// Simple shim to make a Map look like local/session storage\nexport class FakeStorage {\n  constructor() { this._storage = new Map() }\n  setItem(a, b) { return this._storage.set(a, b) }\n  getItem(a) { return this._storage.get(a) }\n  removeItem(a) { return this._storage.delete(a) }\n}\n\nfunction getStorage(storeLocally = true) {\n  let storage\n  try {\n    if (!storeLocally ||\n        typeof window !== 'object' ||\n        window.localStorage === undefined) {\n      storage = new FakeStorage()\n    } else {\n      // Mobile safari in private browsing has a localStorage, but it\n      // has a size limit of 0\n      window.localStorage.setItem('$$fake', 1)\n      window.localStorage.removeItem('$$fake')\n      storage = window.localStorage\n    }\n  } catch (error) {\n    if (window.sessionStorage === undefined) {\n      storage = new FakeStorage()\n    } else {\n      storage = window.sessionStorage\n    }\n  }\n  return storage\n}\n\nexport class TokenStorage {\n  constructor({ authType = 'token',\n                storage = getStorage(authType.storeLocally),\n                path = 'horizon' } = {}) {\n    this._storage = storage\n    this._path = path\n    if (typeof authType === 'string') {\n      this._authType = authType\n    } else {\n      this._authType = 'token'\n      this.set(authType.token)\n    }\n  }\n\n  _getHash() {\n    const val = this._storage.getItem(HORIZON_JWT)\n    if (val == null) {\n      return {}\n    } else {\n      return JSON.parse(val)\n    }\n  }\n\n  _setHash(hash) {\n    this._storage.setItem(HORIZON_JWT, JSON.stringify(hash))\n  }\n\n  set(jwt) {\n    const current = this._getHash()\n    current[this._path] = jwt\n    this._setHash(current)\n  }\n\n  get() {\n    return this._getHash()[this._path]\n  }\n\n  remove() {\n    const current = this._getHash()\n    delete current[this._path]\n    this._setHash(current)\n  }\n\n  setAuthFromQueryParams() {\n    const parsed = typeof window !== 'undefined' &&\n      typeof window.location !== 'undefined' ?\n            queryParse(window.location.search) : {}\n\n    if (parsed.horizon_token != null) {\n      this.set(parsed.horizon_token)\n    }\n  }\n\n  // Handshake types are implemented here\n  handshake() {\n    // If we have a token, we should send it rather than requesting a\n    // new one\n    const token = this.get()\n    if (token != null && this._authType === 'token') {\n      return { method: 'token', token }\n    } else if (this._authType === 'token') {\n      throw new Error('Attempting authenticated login but no token detected. Make sure you\\'ve logged in before attempting to call connect or make a query.')\n    } else {\n      return { method: this._authType }\n    }\n  }\n\n  // Whether there is an auth token for the provided authType\n  hasAuthToken() {\n    const token = this.get()\n    if (!token) {\n      return false\n    }\n    try {\n      const meta = JSON.parse(atob(token.split('.')[1]))\n      const exp = meta.exp\n      const now = new Date().getTime() / 1000\n      return (now < exp)\n    } catch (e) {\n      return false\n    }\n  }\n}\n\nexport function clearAuthTokens() {\n  return getStorage().removeItem(HORIZON_JWT)\n}\n"]}